# Rubin FoVViewer on Kubernetes

LSSTカメラから出力されるデータは非常に大きい。
圧縮されていなければ 4k x 4k x 4bytes x 205ccds = 13GB ほどのデータが１ショットに含まれる。
（生データは圧縮されていると１ショットあたり4GB程度まで小さくなることもある。）

これをブラウザで高速に表示するには、データをいくつかの解像度でタイル状に分割する処理が必要である。
このアプリケーションはそのタイル分割をKubernetes上で並列に実行するためのものである。

## 元データ

元データはクラスターからアクセスできるObject Storage内に保存されている。

## 処理の流れ

### タイル生成

LSSTカメラの焦点面には205個のCCDが敷き詰められている。
CCDの配置を反映して、205個のCCDのデータを焦点面に配置した巨大な画像Fを考える。
Fは64000 x 64000程度の巨大なものになる。
Fを1倍、1/2倍、1/4倍、...の倍率で縮小画像を生成し、それぞれを256ピクセル x 256ピクセルのタイルに分割する。
タイルは`$x/$y/$x.npy`でアクセスできるように保存する(2**zが倍率、x, yはタイルの位置)。

このプロセスを素直に行うと実行に時間がかかるため、実際には以下のように並列化して実行する。

1. Coordinatorが複数のノード（これをGeneratorと呼ぶ）に分担するCCDを割り当てる
  * どのCCDがどのGeneratorに割り当てられたかを記録する。
1. 各Generatorで次の処理を行う
  1. 分担した各CCDについて次の処理を行う
    1. CCDのデータを読み込む
    1. 1倍、1/2倍、1/4倍、...の倍率で次の処理を行う
      1. 画像をタイル分割してローカルの高速な保存する

ここまでの処理を行うと、CCDごとのタイルデータが複数のGeneratorに分割して保存される。
タイルデータのリクエストがあれば、そのタイルを分担しているGenerator（複数の可能性がある）から取得しマージして返す。

### タイルのストレージへの転送

タイル生成をした直後は、各Generatorのローカルストレージにタイルデータが保存されている。
Kubernetesのローカルストレージはephemeralであるため、タイル生成が終わったらタイルデータをObject Storageに転送する。
その際に複数のCCDを含むタイルはマージしてからObject Storageに転送する。
